name: Automerge replit-dev â†’ main (fast-forward only)

on:
  push:
    branches: [ replit-dev ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ffmerge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git author
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch branches
        run: |
          git fetch origin main replit-dev

      - name: Fast-forward main to replit-dev
        run: |
          set -e
          git checkout -B main origin/main
          git merge --ff-only origin/replit-dev

      - name: Push to main (GITHUB_TOKEN)
        id: push_gh_token
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -e
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git push origin main

      - name: Push to main (PAT fallback)
        if: ${{ steps.push_gh_token.outcome == 'failure' }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e
          if [ -z "${GH_PAT:-}" ]; then
            echo "::warning::GH_PAT not set; cannot fallback-push to main."
            exit 0
          fi
          git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          git push origin main
